#!/usr/bin/env ruby
require 'optparse'
require 'rumbster'
require 'redis'
require 'mail'
require 'HollaBack/MailServer/holla_back_observer'

options = {:smtp_port  => 2525,
           :redis_host => 'localhost',
           :redis_port => 6379}

OptionParser.new {|opts|
  opts.banner = "Usage: mail_server [options]"
  opts.on("-p",
          "--smtp-port",
          OptionParser::DecimalInteger,
          "SMTP Port. Defaults to #{options[:smtp_port]}") do |p|
    options[:smtp_port] = p
  end

  opts.on("--redis-port",
          OptionParser::DecimalInteger,
          "Redis Port. Defaults to #{options[:redis_port]}") do |p|
    options[:redis_port] = p.to_i
  end

  opts.on("--redis-host",
          "Redis Host. Defaults to #{options[:redis_host]}") do |h|
    options[:redis_host] = h
  end
}.parse!

redis = Redis.connect(:host => options[:redis_host],
                      :port => options[:redis_port])
server = Rumbster.new(options[:smtp_port])
server.add_observer(HollaBackObserver.new(redis))

at_exit { server.stop }
puts "Ready"
server.start
sleep
